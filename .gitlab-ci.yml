stages:
  - lint
  - test
  - build

variables:
  CARGO_HOME: $CI_PROJECT_DIR/.cargo
  APT_CACHE_DIR: $CI_PROJECT_DIR/apt-cache

cache:
  paths:
    - .cargo/
    - target/
    - apt-cache/

before_script:
  - mkdir -p apt-cache
  - apt-get update -yq && apt-get install -o dir::cache::archives="apt-cache" -y protobuf-compiler libssl-dev pkg-config

rustfmt:
  stage: lint
  image: rust:1.80-slim
  tags:
    - docker
  script:
    - rustup component add rustfmt
    - cargo fmt --all -- --check

clippy:
  stage: lint
  image: rust:1.80-slim
  tags:
    - docker
  script:
    - rustup component add clippy
    - cargo clippy -- -D warnings

test:
  stage: test
  image: rust:1.80-slim
  tags:
    - docker
  script:
    - cargo test --lib core

build:
  stage: build
  image: docker:24.0.5
  tags:
    - docker
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
    - docker build -f docker/prod.Dockerfile -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .
    - |
      if [ "$CI_COMMIT_BRANCH" == "$CI_DEFAULT_BRANCH" ]; then
        docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG $CI_REGISTRY_IMAGE:latest
      fi
    # Примечание: Для пуша в реестр раскомментируйте строки ниже и настройте переменные в GitLab
    # - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    # - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
